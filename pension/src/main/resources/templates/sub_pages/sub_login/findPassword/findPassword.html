<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>비밀번호 찾기</title>
    <link rel="stylesheet" href="/static/css/reset.css">
    <link rel="stylesheet" href="/static/css/sub/sub_login/find/findPassword.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>

<body>
    <div class="wrap">
        <h1 class="logo_box">
            <a href="/">
                <img src="/static/images/logo.png" alt="logo">
            </a>
        </h1>
        <form action="">
            <h2>
                계정정보 찾기
            </h2>
            <div class="tab_box">
                <ul>
                    <li>
                        <a href="/find/findId" class="find_id">아이디 찾기</a>
                    </li>
                    <li>
                        <a href="/find/findPassword" class="find_pw">비밀번호 찾기</a>
                    </li>
                </ul>
                <div class="remove_line">

                </div>
            </div>
            <section class="user_info show">
                <table>
                    <tbody>
                        <tr>
                            <th>아이디</th>
                            <td>
                                <input type="text" class="userid">
                            </td>
                        </tr>
                        <tr>
                            <th>이름</th>
                            <td>
                                <input type="text" class="name">
                            </td>
                        </tr>
                        <tr>
                            <th>이메일</th>
                            <td>
                                <input type="text" class="email">
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="section_bottom">
                    <button class="find_pw_button">비밀번호 찾기</button>
                </div>
            </section>
        </form>
        <form action="">
            <div class="finded_userpw hidden">
                <p class="ment">
                    <i class="fa-solid fa-check"></i>&nbsp;새 비밀번호를 입력해주세요.
                </p>
                <p class="ment mt10">
                    <i class="fa-solid fa-check"></i>&nbsp;비밀번호는 8 ~ 20자리로 설정해주세요.
                </p>
                <table class="new_table">
                    <tbody>
                    <tr>
                        <th>새 비밀번호 입력</th>
                        <td>
                            <input type="password" class="userpw" minlength="8" maxlength="20">
                        </td>
                    </tr>
                    <tr>
                        <th>새 비밀번호 확인</th>
                        <td>
                            <input type="password" class="userpw_check" minlength="8" maxlength="20">
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div class="change_pw_btn_box">
                    <button class="change_pw_btn">변경하기</button>
                </div>
                <div class="hidden_userid hidden">

                </div>
                <div class="hidden_userpw hidden">

                </div>
            </div>
        </form>
    </div>
    <script>
        let userid = document.querySelector('.userid');
        let name = document.querySelector('.name');
        let email = document.querySelector('.email');
        let exptext =
            /^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/i;
        let findPwBtn = document.querySelector('.find_pw_button');
        let userInfo = document.querySelector('.user_info');
        let findedUserpw = document.querySelector('.finded_userpw');
        let newPw = document.querySelector('.userpw');
        let checkNewPw = document.querySelector('.userpw_check');
        let changePwBtn = document.querySelector('.change_pw_btn');
        let hiddenUserid = document.querySelector('.hidden_userid');
        let hiddenUserpw = document.querySelector('.hidden_userpw');

        findPwBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (userid.value == "") {
                alert("아이디를 입력해주세요.");
                userid.focus();
                return false;
            } else if (name.value == "") {
                alert("이름을 입력해주세요.");
                name.focus();
                return false;
            } else if (email.value == "") {
                alert("이메일을 입력해주세요.");
                email.focus();
                return false;
            } else if (exptext.test(email.value) == false) {
                alert("이메일 형식이 올바르지 않습니다.");
                email.focus();
                return false;
            } else {
                let obj = {
                    userid: userid.value,
                    name: name.value,
                    email: email.value
                }
                $.ajax({
                    type: 'post',
                    url: "/find/findPassword",
                    data: obj,
                    dataType: 'json',
                    success: (result) => {
                        if (result.msg == "success") {
                            alert("success");
                            userInfo.classList.remove('show');
                            userInfo.classList.add('hidden');
                            findedUserpw.classList.remove('hidden');
                            findedUserpw.classList.add('show');
                            hiddenUserid.innerHTML = `${result.hiddenUserid}`;
                            hiddenUserpw.innerHTML = `${result.hiddenUserpw}`;
                            changePwBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                // alert("ok");
                                if (newPw.value == "") {
                                    alert("설정하실 비밀번호를 입력해주세요.");
                                    newPw.focus();
                                    return false;
                                } else if (newPw.value.length < 8) {
                                    alert("비밀번호를 8자리 이상으로 설정해주세요.");
                                    newPw.value = "";
                                    newPw.focus();
                                    return false;
                                } else if (newPw.value != checkNewPw.value) {
                                    alert("입력하신 비밀번호와 비밀번호 확인란이 일치하지 않습니다.\n비밀번호를 다시 입력해주세요.");
                                    checkNewPw.value = "";
                                    checkNewPw.focus();
                                    return false;
                                } else {
                                    let obj = {
                                        newPw: newPw.value,
                                        hiddenUserid: hiddenUserid.innerHTML,
                                        hiddenUserpw: hiddenUserpw.innerHTML
                                    }
                                    $.ajax({
                                        type: 'post',
                                        url: "/setNewPassword",
                                        data: obj,
                                        dataType: 'json',
                                        success: (result) => {
                                            console.log(result.msg);
                                            if (result.msg == "none") {
                                                alert("사용하던 비밀번호로는 설정할 수 없습니다.\n다른 비밀번호로 설정해주세요.");
                                                newPw.value = "";
                                                checkNewPw.value = "";
                                                newPw.focus();
                                            }
                                            else if (result.msg == "change") {
                                                alert("비밀번호 변경이 완료되었습니다.\n로그인 페이지로 이동합니다.");
                                                location.href = "/login";
                                            }
                                        }
                                    })
                                }
                            });

                        } else {
                            alert("회원정보가 잘못되었습니다.\n다시 입력해주세요.");
                            userid.value = "";
                            name.value = "";
                            email.value = "";
                            userid.focus();
                        }
                    }
                })
            }
        });
    </script>
</body>

</html>